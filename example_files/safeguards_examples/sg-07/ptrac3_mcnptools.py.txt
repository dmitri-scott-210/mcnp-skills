#!/usr/bin/env python
# =====================================================================================
import numpy as np
import matplotlib.pyplot as plt

from mcnptools import Ptrac


# =====================================================================================
def filter_history_times(history, cells, zas, rxns):
    """ Function to process a Ptrac history into a sorted list of reaction times """

    number_events = history.GetNumEvents()

    times = list()
    for ievent in range(number_events):
        event = history.GetEvent(ievent)

        if event.Type() == Ptrac.COL:
            # Gather particle collision cell, isotope, and reaction
            cell = int(event.Get(Ptrac.CELL))
            za = int(event.Get(Ptrac.ZAID))
            rxn = int(event.Get(Ptrac.RXN))

            # Filter all capture reactions within cells and isotopes
            if cell in cells and za in zas and rxn in rxns:
                times.append(event.Get(Ptrac.TIME))

    return sorted(times)


# =====================================================================================
def histogram_time_gate(times, predelay_time, gate_width):
    """ Function to process a list of times into a histogram of coincident counts. """

    number_times = len(times)

    counts = np.zeros(number_times)
    for itime in range(number_times):
        # Time when gate is opened
        t0 = times[itime]

        count = 0
        for jtime in range(itime + 1, number_times):
            # Next time before pre-delay time... no count
            if times[jtime] < t0 + predelay_time:
                pass
            # Next time within pre-delay and gate time... count
            elif times[jtime] <= t0 + predelay_time + gate_width:
                count += 1
            # Next time after pre-delay and gate time... no count
            else:
                break
        counts[count] += 1

    return counts


# =====================================================================================
max_counts = 0
count_histogram = np.zeros(100)

# Open file and then read a chunk of 1000 histories
ptrac_handle = Ptrac("ptrac3b.txtp", Ptrac.BIN_PTRAC)
ptrac_hists = ptrac_handle.ReadHistories(1000)
while ptrac_hists:

    # Iterate through each individual history
    for hist in ptrac_hists:

        # Call time filter function to get sorted list of capture times
        times = filter_history_times(
            hist, cells=[21, 22, 23, 24], zas=[2003], rxns=[101]
        )

        # Call histogram function to process capture times
        counts = histogram_time_gate(times, predelay_time=500, gate_width=10000)
        max_counts = max(max_counts, len(counts))

        # Accumulate history histogram into total histogram
        for icount, count in enumerate(counts):
            count_histogram[icount] += count

    # Read next chunk of 1000 histories
    ptrac_hists = ptrac_handle.ReadHistories(1000)


# Print total histogram
for icount, count in enumerate(count_histogram[:max_counts]):
    print(f"Count Outcome = {icount}, Total Counts = {int(count)}")
if max_counts == 0 and count_histogram[0] == 0:
    print("Zero Capture Events Found!!!")

# Plot total histogram
x = [i - 0.5 for i in range(max_counts + 1)]
xticks = [i for i in range(max_counts)]

fig, ax = plt.subplots(1, 1)
ax.step(x, count_histogram[: max_counts + 1], where="post")
ax.set_xticks(xticks)
ax.set_xlabel("Count Outcome")
ax.set_ylabel("Total Counts")
ax.set_title("Coincident Count Histogram")

plt.grid(axis="y")
plt.show()

fig.savefig("ptrac3_mcnptools_plot.pdf", bbox_inches='tight')
