# MCNP Advanced Input Techniques

**Reference Document for mcnp-input-builder Skill**

Advanced techniques for input file generation, modularization, version compatibility, and restart capabilities.

---

## Programmatic Input Generation

### Python Script Template

Basic Python script for generating MCNP inputs:

```python
"""
MCNP Input Generator
Generates MCNP input files from templates and parameters
"""

def write_mcnp_input(filename, cells, surfaces, materials, source, tallies):
    """Generate complete MCNP input file"""
    with open(filename, 'w') as f:
        # Title
        f.write("MCNP Input Generated by Script\n")
        f.write("c " + "="*65 + "\n\n")

        # Cell cards
        f.write("c " + "="*65 + "\n")
        f.write("c Cell Cards\n")
        f.write("c " + "="*65 + "\n")
        for cell in cells:
            f.write(f"{cell['id']:5d} {cell['mat']:3d} {cell['dens']:10.6f} "
                    f"{cell['geom']:20s} IMP:N={cell['imp']}\n")
        f.write("\n")

        # Surface cards
        f.write("c " + "="*65 + "\n")
        f.write("c Surface Cards\n")
        f.write("c " + "="*65 + "\n")
        for surf in surfaces:
            f.write(f"{surf['id']:5d} {surf['type']:4s} {surf['params']}\n")
        f.write("\n")

        # Data cards
        f.write("c " + "="*65 + "\n")
        f.write("c Data Cards\n")
        f.write("c " + "="*65 + "\n")
        f.write("MODE  N\n")

        # Materials
        for mat in materials:
            f.write(f"M{mat['id']}  {mat['composition']}\n")

        # Source
        f.write(f"SDEF  {source}\n")

        # Tallies
        for tally in tallies:
            f.write(f"F{tally['type']}:N  {tally['cells']}\n")

        # Termination
        f.write("NPS  1000000\n")
        f.write("\n")  # Blank line at EOF

# Example usage
cells = [
    {'id': 1, 'mat': 1, 'dens': -1.0, 'geom': '-1', 'imp': 1},
    {'id': 2, 'mat': 0, 'dens': 0, 'geom': '1', 'imp': 0}
]
surfaces = [{'id': 1, 'type': 'SO', 'params': '10.0'}]
materials = [{'id': 1, 'composition': '1001  2  8016  1'}]
source = 'POS=0 0 0  ERG=14.1'
tallies = [{'type': 4, 'cells': '1'}]

write_mcnp_input('generated_input.i', cells, surfaces, materials, source, tallies)
```

---

## Input File Modularization

### Multi-File Structure

Organize large inputs across multiple files using READ command:

**Project Structure:**
```
project/
├── main_input.i           # Main file
├── geometry/
│   ├── core.txt          # Core geometry
│   ├── reflector.txt     # Reflector
│   └── shielding.txt     # Shield
├── materials/
│   ├── fuel.txt          # Fuel materials
│   └── structural.txt    # Structures
└── tallies/
    └── detectors.txt     # Tally specifications
```

**Main Input (main_input.i):**
```
Modular Input File - Reactor Core
c =================================================================

c =================================================================
c Cell Cards - Read from external files
c =================================================================
READ  FILE=geometry/core.txt
READ  FILE=geometry/reflector.txt
READ  FILE=geometry/shielding.txt
999  0  999  IMP:N=0                $ Graveyard

c =================================================================
c Surface Cards
c =================================================================
999  SO  500.0                      $ Outer boundary

c =================================================================
c Data Cards
c =================================================================
MODE  N
READ  FILE=materials/fuel.txt
READ  FILE=materials/structural.txt
KCODE  10000  1.0  50  150
KSRC   0 0 0
READ  FILE=tallies/detectors.txt
PRINT
```

**External File Example (materials/fuel.txt):**
```
c =================================================================
c Fuel Materials
c =================================================================
M1   92235  0.05  92238  0.95        $ UO2 fuel (5% enriched)
M2   40000  1.0                      $ Zircaloy cladding
MT1  LWTR.01T                        $ Light water S(α,β)
```

---

## Restart Capabilities

### CONTINUE Keyword

Resume calculation from previous run:

**Initial Run:**
```
Simple Problem - Initial Run
c =================================================================
...
NPS  1000000
PRDMP  1000000 1000000 1           $ Create dump at 1M histories
```

**Restart Run:**
```
CONTINUE                             $ Continue from previous runtpe
c =================================================================
c Restart from 1M histories, run to 2M
c =================================================================
NPS  2000000                         $ Total NPS (not additional)
```

### RUNTPE File

MCNP creates `runtpe.h5` (HDF5 format) containing:
- Problem state at dump points
- Random number generator state
- Source information
- Tally accumulators

**Usage:**
1. Initial run creates runtpe.h5
2. Restart run reads runtpe.h5 with CONTINUE
3. Accumulates additional histories
4. Combines statistics

---

## Version-Specific Considerations

### MCNP5 vs MCNP6 Compatibility

**MCNP6-Only Features:**
- BURN card (burnup/depletion)
- FMESH with OUT=xdmf (HDF5 mesh output)
- Enhanced unstructured mesh (UMESH)
- Additional S(α,β) libraries
- Expanded physics models

**MCNP5-Compatible Input:**
```
c For MCNP5 compatibility, avoid:
c - FMESH with OUT=xdmf
c - BURN card
c - Unstructured mesh (UMESH)

c Use TMESH instead of FMESH:
TMESH
      RMESH1:N  FLUX
      CORA1     -10  10  10I
      CORB1     -10  10  10I
      CORC1     -10  10  10I
ENDMD
```

---

## Large Simulation Best Practices

### 1. Checkpoint Strategy
Use PRDMP for regular dumps:
```
PRDMP  j  ndp  ndm  mct  ndmp  dmmp
```

**Example:**
```
PRDMP  10000000  10000000  1        $ Dump every 10M histories
```

### 2. Parallel Execution
```
mcnp6 inp=input.i tasks 8           $ 8 threads
mpirun -n 16 mcnp6 inp=input.i      $ 16 MPI processes
```

### 3. Memory Management
For large problems:
- Use importance (IMP) to focus sampling
- Reduce tally binning
- Consider mesh vs cell tallies
- Monitor memory usage during run

---

## Further Reading

- MCNP6 User Manual, Chapter 6: Output
- MCNP6 User Manual, Appendix C: Parallel Computing
- Skills: mcnp-parallel-configurator, mcnp-template-generator

---

**End of Advanced Techniques**
