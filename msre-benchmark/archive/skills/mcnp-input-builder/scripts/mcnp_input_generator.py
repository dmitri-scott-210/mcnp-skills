#!/usr/bin/env python3
"""
MCNP Input Generator

Template-based MCNP input file generator for common problem types.
Generates properly formatted input files from parameterized templates.

Usage:
    python mcnp_input_generator.py --template basic --output input.i --params params.json
    python mcnp_input_generator.py --interactive

Requirements:
    Python 3.8+
    No external dependencies (uses standard library only)
"""

import argparse
import json
import sys
from pathlib import Path
from typing import Dict, List, Any


def write_cell_block(cells: List[Dict[str, Any]], file) -> None:
    """Write cell cards block to file.

    Args:
        cells: List of cell dictionaries with keys:
            - id: Cell number
            - mat: Material number (0 for void)
            - dens: Density (g/cm³ if positive, atoms/barn-cm if negative)
            - geom: Geometry specification (surface boolean)
            - imp: Importance value
            - vol: Volume (optional)
        file: Open file handle
    """
    file.write("c " + "="*65 + "\n")
    file.write("c Cell Cards\n")
    file.write("c " + "="*65 + "\n")

    for cell in cells:
        # Format density field
        if cell['mat'] == 0:
            dens_str = "      "  # Void has no density
        else:
            dens_str = f"{cell['dens']:10.6f}"

        # Base cell card
        line = f"{cell['id']:5d} {cell['mat']:3d} {dens_str} {cell['geom']:20s} IMP:N={cell['imp']}"

        # Add optional volume
        if 'vol' in cell and cell['vol'] > 0:
            line += f"  VOL={cell['vol']:.2f}"

        # Add comment if provided
        if 'comment' in cell:
            line += f"  $ {cell['comment']}"

        file.write(line + "\n")

    file.write("\n")


def write_surface_block(surfaces: List[Dict[str, Any]], file) -> None:
    """Write surface cards block to file.

    Args:
        surfaces: List of surface dictionaries with keys:
            - id: Surface number
            - type: Surface type (SO, PX, CZ, etc.)
            - params: Parameter string
            - comment: Comment (optional)
        file: Open file handle
    """
    file.write("c " + "="*65 + "\n")
    file.write("c Surface Cards\n")
    file.write("c " + "="*65 + "\n")

    for surf in surfaces:
        line = f"{surf['id']:5d} {surf['type']:4s} {surf['params']}"

        if 'comment' in surf:
            # Pad to column 50 for aligned comments
            line = line.ljust(50) + f"$ {surf['comment']}"

        file.write(line + "\n")

    file.write("\n")


def write_data_block(materials: List[Dict[str, Any]],
                     source: Dict[str, Any],
                     tallies: List[Dict[str, Any]],
                     nps: int,
                     file) -> None:
    """Write data cards block to file.

    Args:
        materials: List of material dictionaries
        source: Source specification dictionary
        tallies: List of tally dictionaries
        nps: Number of particle histories
        file: Open file handle
    """
    file.write("c " + "="*65 + "\n")
    file.write("c Data Cards\n")
    file.write("c " + "="*65 + "\n")
    file.write("MODE  N\n")

    # Materials
    if materials:
        file.write("c --- Materials ---\n")
        for mat in materials:
            file.write(f"M{mat['id']}  {mat['composition']}")
            if 'comment' in mat:
                file.write(f"  $ {mat['comment']}")
            file.write("\n")

            if 'thermal' in mat:
                file.write(f"MT{mat['id']}  {mat['thermal']}\n")
        file.write("\n")

    # Source
    file.write("c --- Source Definition ---\n")
    if source['type'] == 'SDEF':
        file.write(f"SDEF  {source['spec']}\n")
    elif source['type'] == 'KCODE':
        file.write(f"KCODE  {source['spec']}\n")
        file.write(f"KSRC   {source['ksrc']}\n")
    file.write("\n")

    # Tallies
    if tallies:
        file.write("c --- Tallies ---\n")
        for tally in tallies:
            file.write(f"F{tally['type']}:N  {tally['cells']}")
            if 'comment' in tally:
                file.write(f"  $ {tally['comment']}")
            file.write("\n")

            if 'energy_bins' in tally:
                file.write(f"E{tally['type']}  {tally['energy_bins']}\n")
        file.write("\n")

    # Termination
    file.write("c --- Problem Termination ---\n")
    if source['type'] != 'KCODE':
        file.write(f"NPS  {nps}\n")
    file.write("PRINT\n")
    file.write("\n")  # Blank line at EOF


def create_basic_input(params: Dict[str, Any], output_file: Path) -> None:
    """Create basic fixed-source input from parameters.

    Args:
        params: Parameter dictionary
        output_file: Output file path
    """
    with open(output_file, 'w') as f:
        # Title
        title = params.get('title', 'MCNP Input Generated by Script')
        f.write(f"{title}\n")
        f.write("c " + "="*65 + "\n\n")

        # Cells
        write_cell_block(params['cells'], f)

        # Surfaces
        write_surface_block(params['surfaces'], f)

        # Data cards
        write_data_block(
            params.get('materials', []),
            params['source'],
            params.get('tallies', []),
            params.get('nps', 1000000),
            f
        )

    print(f"✓ Created input file: {output_file}")


def interactive_mode() -> None:
    """Interactive input file creation."""
    print("="*70)
    print("MCNP Input Generator - Interactive Mode")
    print("="*70)
    print("\nCreate a simple sphere problem interactively.\n")

    # Get basic parameters
    title = input("Problem title: ") or "Interactive Problem"
    radius = float(input("Sphere radius (cm) [10.0]: ") or "10.0")
    mat_num = int(input("Material number [1]: ") or "1")
    density = float(input("Density (g/cm³, negative for atoms/barn-cm) [-1.0]: ") or "-1.0")
    energy = float(input("Source energy (MeV) [14.1]: ") or "14.1")
    nps = int(input("Number of histories [1000000]: ") or "1000000")

    # Ask for material composition
    print("\nMaterial composition (ZAID fraction pairs):")
    print("  Example: 1001 2 8016 1  (for H2O)")
    composition = input("Composition: ") or "1001 2 8016 1"

    # Build parameter dictionary
    params = {
        'title': title,
        'cells': [
            {'id': 1, 'mat': mat_num, 'dens': density, 'geom': '-1',
             'imp': 1, 'vol': 4.18879 * radius**3, 'comment': 'Active region'},
            {'id': 2, 'mat': 0, 'dens': 0, 'geom': '1',
             'imp': 0, 'comment': 'Graveyard'}
        ],
        'surfaces': [
            {'id': 1, 'type': 'SO', 'params': f'{radius:.2f}',
             'comment': f'Sphere R={radius} cm'}
        ],
        'materials': [
            {'id': mat_num, 'composition': composition, 'comment': 'Material'}
        ],
        'source': {
            'type': 'SDEF',
            'spec': f'POS=0 0 0  ERG={energy}'
        },
        'tallies': [
            {'type': 4, 'cells': '1', 'comment': 'Flux in active region',
             'energy_bins': '0.01 0.1 1 10'}
        ],
        'nps': nps
    }

    # Generate output filename
    output_file = Path(f"{title.lower().replace(' ', '_')}.i")

    # Create input
    create_basic_input(params, output_file)
    print(f"\n✓ Input file created: {output_file}")
    print(f"\nTo run: mcnp6 inp={output_file} outp={output_file.stem}.o")


def main():
    """Main entry point."""
    parser = argparse.ArgumentParser(
        description='Generate MCNP input files from templates',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  # Interactive mode
  python mcnp_input_generator.py --interactive

  # From parameters file
  python mcnp_input_generator.py --params params.json --output input.i

Parameters JSON format:
  {
    "title": "Problem Title",
    "cells": [{"id": 1, "mat": 1, "dens": -1.0, "geom": "-1", "imp": 1}],
    "surfaces": [{"id": 1, "type": "SO", "params": "10.0"}],
    "materials": [{"id": 1, "composition": "1001 2 8016 1"}],
    "source": {"type": "SDEF", "spec": "POS=0 0 0 ERG=14.1"},
    "tallies": [{"type": 4, "cells": "1"}],
    "nps": 1000000
  }
        """
    )

    parser.add_argument('--interactive', '-i', action='store_true',
                        help='Interactive mode (guided input creation)')
    parser.add_argument('--params', '-p', type=Path,
                        help='Parameters JSON file')
    parser.add_argument('--output', '-o', type=Path,
                        help='Output input file')

    args = parser.parse_args()

    # Interactive mode
    if args.interactive:
        interactive_mode()
        return

    # Parameters file mode
    if args.params and args.output:
        if not args.params.exists():
            print(f"Error: Parameters file not found: {args.params}", file=sys.stderr)
            sys.exit(1)

        with open(args.params) as f:
            params = json.load(f)

        create_basic_input(params, args.output)
        return

    # No valid options
    parser.print_help()
    print("\nError: Must specify either --interactive or (--params and --output)")
    sys.exit(1)


if __name__ == '__main__':
    main()
