# Advanced Material Cards Reference

## Purpose
Reference for advanced and specialized material-related data cards: OTFDB, NONU, AWTAB, XS, DRXS.

---

## OTFDB: On-the-Fly Doppler Broadening

### Purpose
Apply on-the-fly (OTF) Doppler broadening to neutron cross sections for temperature-dependent resonances without pre-generating ACE files at each temperature.

### Background
- **Standard approach:** Pre-process ACE files for each temperature (293 K, 600 K, 900 K, etc.)
- **OTFDB approach:** Use coefficient files to broaden cross sections at any temperature during transport
- **Advantage:** Eliminates need for temperature-specific ACE files
- **Use case:** Reactor cores with spatially varying temperatures

### Requirements
1. **Coefficient files** generated by `fit_otf` utility (included in MCNP distribution)
2. Files named: `otf_ZAID.nnX.binary` or `otf_ZAID.nnX.txt`
3. Files placed in `$DATAPATH` directory or working directory

### Format
```
OTFDB  zaid1  zaid2  ...  zaidK
```

**zaidk:** Identifiers for OTF Doppler broadening data tables (any format from §1.2.3).

### How It Works
1. MCNP matches Z, A, S from M card with OTFDB identifiers (library identifier ignored)
2. OTFDB data replaces low-energy portion of corresponding dataset
3. Data broadened to TMP card value for each cell containing the material
4. TMP value must be **higher than minimum library temperature** for all cells

### Example 1: UO₂ Fuel with OTF Broadening
```
c Generate coefficient files using fit_otf utility:
c   fit_otf 92235.80c 300 1200
c   fit_otf 92238.80c 300 1200
c   fit_otf 8016.80c 300 1200
c
c This creates: otf_92235.80c.binary, otf_92238.80c.binary, otf_8016.80c.binary

OTFDB  92235.80c  92238.80c  8016.80c

M1   92235  0.03  92238  0.97  8016  2.0
TMP1  7.76e-8                                $ T=900 K (fuel operating temp)

c Cell card:
1    1  -0.0716  -1  IMP:N=1
```

**Result:** All U-235, U-238, O-16 cross sections in material 1 broadened to 900 K on-the-fly.

### Example 2: Water Moderator with OTF
```
OTFDB  H-1.80c  O-16.80c

M2   1001  2  8016  1
MT2  H-H2O.40t                               $ S(α,β) still needed
TMP2  5.17e-8                                $ T=600 K

c Cell card:
2    2  -0.08  -2  IMP:N=1
```

### Generating OTFDB Coefficient Files

**Using fit_otf utility:**
```bash
# Navigate to MCNP_CODE/Utilities/FIT_OTF
# Run fit_otf with: ZAID, Tmin, Tmax
fit_otf 92238.80c 300 1200

# Output: otf_92238.80c.binary (or .txt if specified)
```

**Parameters:**
- **ZAID:** Isotope identifier (matches ACE file)
- **Tmin:** Minimum temperature (K) - must match ACE file base temperature
- **Tmax:** Maximum temperature (K) for coefficient fitting

**See:** MCNP User Manual §E.3 for fit_otf input specifications.

### Limitations
- **Only for neutrons:** Not applicable to photons, electrons, protons
- **Resonance region:** Affects resolved/unresolved resonance regions only
- **TMP requirement:** All cells (including voids) must have TMP ≥ base library temperature

### Integration with DBRC
OTFDB and DBRC (Doppler Broadening Rejection Correction) can be used together:

```
OTFDB  92238.80c
M1   92235  0.03  92238  0.97  8016  2.0
TMP1  7.76e-8
DBRC1  92238.80c                             $ Enhanced accuracy for U-238 resonances
```

---

## NONU: Disable Fission

### Purpose
Treat fission as simple capture in specified cells, preventing production of fission neutrons and photons.

### When to Use
- **SSR (Surface Source Read) + fission:** Source already contains fission neutrons
- **Fixed source in multiplying medium:** Fission spectrum pre-calculated
- **Power distribution studies:** Fission neutrons accounted for in source definition
- **KCODE → SSW → SDEF workflow:** Fission source written to file, then read as fixed source

### Format (Cell Card)
```
Cell_card_format:  j  m  d  geometry  params  NONU=a
```

### Format (Data Card)
```
Data_card_format:  NONU  a1  a2  ...  aJ
```

**Number of entries = number of cells** (unless blank, which applies to all cells).

### Values
| Value | Effect |
|-------|--------|
| **a=0** | Fission → capture; gammas produced (DEFAULT if NONU present but blank) |
| **a=1** | Fission treated as real fission; gammas produced (DEFAULT if NONU absent) |
| **a=2** | Fission → capture; gammas NOT produced (use with KCODE → SSW workflow) |

### Example 1: Reactor Core with SSR Source
```
c KCODE run wrote fission source to WSSA file
c Now running fixed-source problem with that source

SSR  WSSA                                    $ Read surface source

c Cells with fissile material:
1    1  -10.96  -1  IMP:N=1  NONU=2          $ Fuel: fission → capture, no gammas
2    2  -1.0    -2  IMP:N=1                  $ Water: normal transport

M1   92235  0.03  92238  0.97  8016  2.0     $ UO₂ fuel
M2   1001  2  8016  1                        $ H₂O moderator
```

**Why NONU=2:**
- Fission neutrons already in SSR source
- Don't want to double-count fission
- Suppress fission gammas (also in source)

### Example 2: Data Card Format
```
NONU  2  1  0                                $ Cell 1: a=2, Cell 2: a=1, Cell 3: a=0
```

### Integration with KCODE
**WRONG:**
```
KCODE  10000  1.0  50  150
NONU                                         $ Don't use NONU with KCODE!
```

**Explanation:** KCODE requires real fission to propagate criticality. Using NONU breaks criticality calculations.

### Use Case: Operating Reactor Power Distribution
```
c Step 1: Run KCODE to get keff and source distribution
KCODE  10000  1.0  50  150
SSW   WSSA  CEL=1 2 3                        $ Write fission source to file

c Step 2: Run fixed-source with fission disabled
SSR  WSSA                                    $ Read source
NONU  2 2 2 0 0 0                           $ Disable fission in cells 1-3 only
```

---

## AWTAB: Atomic Weight Table

### Purpose
Override atomic weight ratios from xsdir file and cross-section tables.

### When to Use
- **XS card usage:** Custom cross-section files missing from xsdir
- **Rare isotopes:** Isotopes with incorrect/missing atomic weights in xsdir
- **Non-standard data:** User-provided evaluations

### Format
```
AWTAB  z1  a1  z2  a2  ...  zK  aK
```

**zk:** Nuclide or element identifier (§1.2.2)
**ak:** Atomic weight ratio (relative to neutron mass = 1.00866 u)

### Example
```
XS1  90233.99c  233.0  90233  ...           $ Custom Th-233 evaluation (hypothetical)
AWTAB  90233  231.0363                      $ Set atomic weight ratio for Th-233

M1   90233.99c  1.0                          $ Use custom Th-233 data
```

### Caution
**WARNING:** Using incorrect atomic weight ratios can lead to:
- Negative neutron energies (fatal error)
- Incorrect kinematics
- Energy conservation violations

**Recommendation:** Use AWTAB only when absolutely necessary. Verify atomic weights from reliable sources (NIST, IAEA).

### Default Behavior
If AWTAB absent, atomic weights from:
1. Cross-section table header (if available)
2. xsdir file entry

---

## XS: Cross-Section File

### Purpose
Load cross-section evaluations **not listed in xsdir file**.

### When to Use
- **Custom evaluations:** User-generated ACE files
- **Experimental data:** New isotopes not in standard libraries
- **Special applications:** Rare isotopes, metastables, custom processing

### Format
```
XS n  zaid  awr  filename  access  filetype  address  tablelength  ...
```

**Entries identical to xsdir file format** (except continuation '+' not used).

**See:** Appendix B of MCNP User Manual for complete xsdir entry format.

### Example
```
XS1  92233.99c  233.0403  /data/custom/u233_custom.ace  0  1  1  304512

M1   92233.99c  1.0                          $ Use custom U-233 evaluation
```

### xsdir Format Reminder
Typical xsdir entry:
```
92235.80c  235.0439  /path/to/u235.ace  0  1  1  451203  0  0  2.53e-8
```

**Fields:**
1. ZAID (92235.80c)
2. Atomic weight ratio (235.0439)
3. File path
4. Access type (0=sequential)
5. File type (1=ASCII, 2=binary)
6. Address (byte offset or record number)
7. Table length (entries)
8-10. Additional parameters (temperature, etc.)

### Integration with AWTAB
When using XS for rare isotopes, also use AWTAB:
```
XS1  47110.99c  109.9053  /data/ag110m.ace  0  1  1  125033
AWTAB  47110  109.9053                      $ Match atomic weight

M1   47110.99c  1.0                          $ Ag-110m custom data
```

---

## DRXS: Discrete-Reaction Cross Section

### Purpose
Use discrete-energy treatment instead of continuous-energy for specified nuclides.

### When to Use
- **Multigroup-like behavior** in continuous-energy mode
- **Simplified transport** for specific isotopes
- **Historical compatibility** with older methodologies

### Format
```
DRXS  z1  z2  ...  zK
```

**Requirement:** Discrete data must be available in cross-section libraries.

### Example
```
DRXS  1001  8016                             $ Use discrete treatment for H-1, O-16

M1   1001  2  8016  1                        $ H₂O with discrete treatment
```

### Availability
Discrete data typically available for:
- Light nuclides (H, C, O, N)
- Legacy libraries (older ENDF evaluations)

**Most modern libraries are continuous-energy only.** Check xsdir for discrete data availability.

---

## MPN: Photonuclear Nuclide Selector (DEPRECATED)

### Status
**DEPRECATED** as of MCNP6. Replaced by **MX card** functionality.

### Legacy Usage
```
MPN  m  z1  z2  ...                          $ Old method (don't use)
```

### Modern Replacement
Use MX card instead:
```
MX m:P  z1  z2  ...                          $ Modern method (photonuclear substitution)
```

### Example Conversion
**Old (MPN):**
```
M1   1001  2  8016  1
MPN  1  1000  8000                           $ Old photonuclear selector
```

**New (MX):**
```
M1   1001  2  8016  1
MX1:P  1000  8000                            $ Modern photonuclear substitution
```

**See:** `material_card_specifications.md` for complete MX card documentation.

---

## Summary Table: When to Use Each Card

| Card | Use Case | Frequency | Complexity |
|------|----------|-----------|------------|
| **OTFDB** | Temperature-varying fuel | Medium | High |
| **NONU** | SSR + fission, power distribution | Medium | Low |
| **AWTAB** | Custom XS files, rare isotopes | Rare | Low |
| **XS** | Evaluations not in xsdir | Rare | Medium |
| **DRXS** | Discrete-energy treatment | Rare | Low |
| **MPN** | Photonuclear (DEPRECATED - use MX) | Never | N/A |

---

## Best Practices

1. **OTFDB:** Generate coefficient files for entire temperature range expected in problem
2. **NONU:** Always use a=2 (no fission gammas) for KCODE → SSW → SDEF workflow
3. **AWTAB:** Verify atomic weights from authoritative sources (NIST, IAEA)
4. **XS:** Document custom evaluation sources and processing history
5. **DRXS:** Check xsdir to confirm discrete data availability before use
6. **MPN:** Convert legacy inputs to MX card format

---

## See Also

- **Material Specifications:** `material_card_specifications.md` for M card keywords and MX details
- **Thermal Scattering:** `thermal_scattering_reference.md` for MT, MT0 cards
- **Error Catalog:** `material_error_catalog.md` for troubleshooting
- **MCNP Documentation:** Chapter 5.6 (Material Data Cards), §E.3 (fit_otf utility)
- **Physics Cards:** Chapter 5.7 for TMP and DBRC cards

---

**Version:** 1.0
**Created:** 2025-11-03
**For:** mcnp-material-builder skill v2.0
